<?xml version="1.0" encoding="UTF-8"?>
<!--
Comprehensive Sysmon Configuration for Custom Security Loggers
==============================================================
This configuration provides extensive monitoring capabilities for advanced threat detection.
It captures more events than the basic configuration but may generate higher log volumes.

ENHANCED VERSION: Improved Event ID 7 coverage for CredentialAccess and PrivilegeEscalation monitoring.

This configuration is designed to work with the Custom Security Loggers project and provides
comprehensive coverage for MITRE ATT&CK techniques including:
- Initial Access (T1566, T1189, T1190)
- Execution (T1059, T1203, T1204)
- Persistence (T1053, T1547, T1543)
- Privilege Escalation (T1055, T1134, T1068) - ENHANCED
- Defense Evasion (T1562, T1055, T1218)
- Credential Access (T1003, T1558, T1555) - ENHANCED
- Discovery (T1083, T1057, T1012)
- Collection (T1005, T1039, T1113)
- Command and Control (T1071, T1095, T1105)

Author: Custom Security Loggers Project
Version: 1.1 (Enhanced)
Compatible with: Sysmon v13+ and Windows Server 2012
-->

<Sysmon schemaversion="4.82">
    <!-- Capture all hashes for better forensics -->
    <HashAlgorithms>md5,sha256,IMPHASH</HashAlgorithms>
    
    <!-- Check for signature revocation -->
    <CheckRevocation>true</CheckRevocation>
    
    <!-- Use archive directory for large files -->
    <ArchiveDirectory>C:\ProgramData\CustomSecurityLogs\SysmonArchive</ArchiveDirectory>
    
    <!-- Event filtering -->
    <EventFiltering>
        
        <!--SYSMON EVENT ID 1 : PROCESS CREATION-->
        <RuleGroup name="" groupRelation="or">
            <ProcessCreate onmatch="exclude">
                <!-- Minimal exclusions to capture suspicious activity -->
                <Image condition="is">C:\Windows\System32\smss.exe</Image>
                <Image condition="is">C:\Windows\System32\csrss.exe</Image>
                <Image condition="is">C:\Windows\System32\wininit.exe</Image>
                <Image condition="is">C:\Windows\System32\winlogon.exe</Image>
                
                <!-- Exclude Windows Defender when not suspicious -->
                <Image condition="begin">C:\ProgramData\Microsoft\Windows Defender\Platform\</Image>
                <CommandLine condition="not contains">powershell</CommandLine>
                <CommandLine condition="not contains">cmd</CommandLine>
                <CommandLine condition="not contains">wscript</CommandLine>
                <CommandLine condition="not contains">cscript</CommandLine>
            </ProcessCreate>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 2 : FILE CREATION TIME CHANGED-->
        <RuleGroup name="" groupRelation="or">
            <FileCreateTime onmatch="include">
                <!-- Monitor timestomping in system directories -->
                <TargetFilename condition="begin">C:\Windows\System32\</TargetFilename>
                <TargetFilename condition="begin">C:\Windows\SysWOW64\</TargetFilename>
                
                <!-- Monitor timestomping of executables and scripts -->
                <TargetFilename condition="end">.exe</TargetFilename>
                <TargetFilename condition="end">.dll</TargetFilename>
                <TargetFilename condition="end">.scr</TargetFilename>
                <TargetFilename condition="end">.com</TargetFilename>
                <TargetFilename condition="end">.bat</TargetFilename>
                <TargetFilename condition="end">.cmd</TargetFilename>
                <TargetFilename condition="end">.ps1</TargetFilename>
                <TargetFilename condition="end">.vbs</TargetFilename>
                <TargetFilename condition="end">.js</TargetFilename>
                <TargetFilename condition="end">.jar</TargetFilename>
            </FileCreateTime>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 3 : NETWORK CONNECTION-->
        <RuleGroup name="" groupRelation="or">
            <NetworkConnect onmatch="exclude">
                <!-- Only exclude localhost -->
                <DestinationIp condition="is">127.0.0.1</DestinationIp>
                <DestinationIp condition="is">::1</DestinationIp>
                
                <!-- Exclude some system processes for private networks only -->
                <Image condition="is">C:\Windows\System32\svchost.exe</Image>
                <DestinationIp condition="begin">10.</DestinationIp>
                
                <Image condition="is">C:\Windows\System32\svchost.exe</Image>
                <DestinationIp condition="begin">192.168.</DestinationIp>
            </NetworkConnect>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 5 : PROCESS TERMINATION-->
        <RuleGroup name="" groupRelation="or">
            <ProcessTerminate onmatch="include">
                <!-- Monitor termination of security tools -->
                <Image condition="contains">defender</Image>
                <Image condition="contains">antivirus</Image>
                <Image condition="contains">firewall</Image>
                <Image condition="contains">security</Image>
                
                <!-- Monitor termination of system processes -->
                <Image condition="end">svchost.exe</Image>
                <Image condition="end">explorer.exe</Image>
                <Image condition="end">winlogon.exe</Image>
                
                <!-- Monitor termination of monitoring tools -->
                <Image condition="contains">sysmon</Image>
                <Image condition="contains">procmon</Image>
                <Image condition="contains">wireshark</Image>
            </ProcessTerminate>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 6 : DRIVER LOADED-->
        <RuleGroup name="" groupRelation="or">
            <DriverLoad onmatch="exclude">
                <!-- Exclude signed Microsoft drivers -->
                <Signature condition="is">Microsoft Windows</Signature>
                <Signature condition="is">Microsoft Corporation</Signature>
                
                <!-- Exclude common hardware vendor drivers -->
                <Signature condition="is">Intel Corporation</Signature>
                <Signature condition="is">NVIDIA Corporation</Signature>
                <Signature condition="is">Advanced Micro Devices, Inc.</Signature>
            </DriverLoad>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 7 : IMAGE/DLL LOADED (ENHANCED FOR CREDENTIAL ACCESS & PRIVILEGE ESCALATION)-->
        <RuleGroup name="" groupRelation="or">
            <ImageLoad onmatch="include">
                <!-- ENHANCED: PowerShell and .NET monitoring -->
                <ImageLoaded condition="contains">powershell</ImageLoaded>
                <ImageLoaded condition="contains">amsi</ImageLoaded>
                <ImageLoaded condition="contains">clr</ImageLoaded>
                <ImageLoaded condition="contains">system.management.automation</ImageLoaded>
                
                <!-- ENHANCED: Credential Access DLLs -->
                <ImageLoaded condition="contains">sekurlsa</ImageLoaded>
                <ImageLoaded condition="contains">kerberos</ImageLoaded>
                <ImageLoaded condition="contains">wdigest</ImageLoaded>
                <ImageLoaded condition="contains">tspkg</ImageLoaded>
                <ImageLoaded condition="contains">samlib</ImageLoaded>
                <ImageLoaded condition="contains">vaultcli</ImageLoaded>
                <ImageLoaded condition="contains">comsvcs</ImageLoaded>
                <ImageLoaded condition="contains">dbgcore</ImageLoaded>
                <ImageLoaded condition="contains">dbghelp</ImageLoaded>
                
                <!-- ENHANCED: Security API monitoring -->
                <ImageLoaded condition="contains">lsasrv</ImageLoaded>
                <ImageLoaded condition="contains">msv1_0</ImageLoaded>
                <ImageLoaded condition="contains">cryptsp</ImageLoaded>
                <ImageLoaded condition="contains">wincred</ImageLoaded>
                <ImageLoaded condition="contains">advapi32</ImageLoaded>
                
                <!-- ENHANCED: Process injection related -->
                <ImageLoaded condition="contains">ntdll</ImageLoaded>
                <ImageLoaded condition="contains">kernel32</ImageLoaded>
                <Image condition="is">C:\Windows\System32\svchost.exe</Image>
                
                <!-- ENHANCED: Privilege escalation DLLs -->
                <ImageLoaded condition="contains">user32</ImageLoaded>
                <ImageLoaded condition="contains">userenv</ImageLoaded>
                <ImageLoaded condition="contains">winsta</ImageLoaded>
                
                <!-- Monitor unsigned DLLs in system processes -->
                <Image condition="is">C:\Windows\System32\svchost.exe</Image>
                <Signed condition="is">false</Signed>
                
                <!-- Monitor DLL injection indicators -->
                <ImageLoaded condition="end">.tmp</ImageLoaded>
                <ImageLoaded condition="contains">\Temp\</ImageLoaded>
                <ImageLoaded condition="contains">\AppData\</ImageLoaded>
            </ImageLoad>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 8 : CREATE REMOTE THREAD-->
        <RuleGroup name="" groupRelation="or">
            <CreateRemoteThread onmatch="exclude">
                <!-- Exclude common system cross-process operations -->
                <SourceImage condition="is">C:\Windows\System32\csrss.exe</SourceImage>
                <SourceImage condition="is">C:\Windows\System32\winlogon.exe</SourceImage>
            </CreateRemoteThread>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 9 : RAW ACCESS READ-->
        <RuleGroup name="" groupRelation="or">
            <RawAccessRead onmatch="include">
                <!-- Monitor raw disk access -->
                <Device condition="contains">HarddiskVolume</Device>
                <Device condition="contains">PhysicalDrive</Device>
            </RawAccessRead>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 10 : PROCESS ACCESS-->
        <RuleGroup name="" groupRelation="or">
            <ProcessAccess onmatch="exclude">
                <!-- Exclude common system interactions -->
                <SourceImage condition="is">C:\Windows\System32\svchost.exe</SourceImage>
                <SourceImage condition="is">C:\Windows\System32\csrss.exe</SourceImage>
                <SourceImage condition="is">C:\Windows\System32\winlogon.exe</SourceImage>
                <SourceImage condition="is">C:\Windows\System32\services.exe</SourceImage>
                
                <!-- Exclude low-privilege access -->
                <GrantedAccess condition="is">0x1000</GrantedAccess>
                <GrantedAccess condition="is">0x1400</GrantedAccess>
            </ProcessAccess>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 11 : FILE CREATE-->
        <RuleGroup name="" groupRelation="or">
            <FileCreate onmatch="exclude">
                <!-- Reduce noise from temp files -->
                <TargetFilename condition="end">.tmp</TargetFilename>
                <TargetFilename condition="end">.log</TargetFilename>
                <TargetFilename condition="end">.bak</TargetFilename>
                <TargetFilename condition="end">~</TargetFilename>
                
                <!-- Exclude browser cache -->
                <TargetFilename condition="contains">\Google\Chrome\User Data\Default\Cache\</TargetFilename>
                <TargetFilename condition="contains">\Mozilla\Firefox\Profiles\</TargetFilename>
                
                <!-- Focus on executable files -->
                <TargetFilename condition="not end">.exe</TargetFilename>
                <TargetFilename condition="not end">.dll</TargetFilename>
                <TargetFilename condition="not end">.scr</TargetFilename>
                <TargetFilename condition="not end">.com</TargetFilename>
                <TargetFilename condition="not end">.bat</TargetFilename>
                <TargetFilename condition="not end">.cmd</TargetFilename>
                <TargetFilename condition="not end">.ps1</TargetFilename>
                <TargetFilename condition="not end">.vbs</TargetFilename>
                <TargetFilename condition="not end">.js</TargetFilename>
                <TargetFilename condition="not end">.jar</TargetFilename>
                <TargetFilename condition="not end">.hta</TargetFilename>
                <TargetFilename condition="not end">.msi</TargetFilename>
                <TargetFilename condition="not end">.doc</TargetFilename>
                <TargetFilename condition="not end">.docx</TargetFilename>
                <TargetFilename condition="not end">.xls</TargetFilename>
                <TargetFilename condition="not end">.xlsx</TargetFilename>
                <TargetFilename condition="not end">.ppt</TargetFilename>
                <TargetFilename condition="not end">.pptx</TargetFilename>
            </FileCreate>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 12 : REGISTRY CREATE/DELETE-->
        <RuleGroup name="" groupRelation="or">
            <RegistryEvent onmatch="include">
                <!-- Persistence locations -->
                <TargetObject condition="contains">CurrentVersion\Run</TargetObject>
                <TargetObject condition="contains">CurrentVersion\RunOnce</TargetObject>
                <TargetObject condition="contains">CurrentVersion\RunServices</TargetObject>
                <TargetObject condition="contains">CurrentVersion\RunServicesOnce</TargetObject>
                <TargetObject condition="contains">\Services\</TargetObject>
                <TargetObject condition="contains">\CurrentVersion\Windows\Load</TargetObject>
                <TargetObject condition="contains">\CurrentVersion\Windows\Run</TargetObject>
                <TargetObject condition="contains">\CurrentVersion\Winlogon\</TargetObject>
                <TargetObject condition="contains">\Policies\Explorer\Run</TargetObject>
                <TargetObject condition="contains">\Group Policy\Scripts</TargetObject>
                
                <!-- Security bypass attempts -->
                <TargetObject condition="contains">\Policies\System\EnableLUA</TargetObject>
                <TargetObject condition="contains">\Windows Defender\</TargetObject>
                <TargetObject condition="contains">\Real-Time Protection</TargetObject>
                
                <!-- Office security settings -->
                <TargetObject condition="contains">\Security\Trusted Documents\</TargetObject>
                <TargetObject condition="contains">\Security\VBAWarnings</TargetObject>
                <TargetObject condition="contains">\Security\ProtectedView\</TargetObject>
                <TargetObject condition="contains">\Security\FileBlock\</TargetObject>
                
                <!-- PowerShell security -->
                <TargetObject condition="contains">\PowerShell\1\ShellIds\Microsoft.PowerShell\ExecutionPolicy</TargetObject>
                <TargetObject condition="contains">\Policies\Microsoft\Windows\PowerShell\</TargetObject>
                
                <!-- Scheduled tasks -->
                <TargetObject condition="contains">\Schedule\TaskCache\Tree\</TargetObject>
                <TargetObject condition="contains">\Schedule\TaskCache\Tasks\</TargetObject>
                
                <!-- Network and proxy settings -->
                <TargetObject condition="contains">\Internet Settings\</TargetObject>
                <TargetObject condition="contains">\Connections\DefaultConnectionSettings</TargetObject>
                
                <!-- WMI persistence -->
                <TargetObject condition="contains">\ROOT\subscription\</TargetObject>
                <TargetObject condition="contains">\ROOT\default\</TargetObject>
            </RegistryEvent>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 13 : REGISTRY VALUE SET-->
        <RuleGroup name="" groupRelation="or">
            <RegistryEvent onmatch="include">
                <!-- All the same locations as Event ID 12 -->
                <TargetObject condition="contains">CurrentVersion\Run</TargetObject>
                <TargetObject condition="contains">CurrentVersion\RunOnce</TargetObject>
                <TargetObject condition="contains">CurrentVersion\RunServices</TargetObject>
                <TargetObject condition="contains">CurrentVersion\RunServicesOnce</TargetObject>
                <TargetObject condition="contains">\Services\</TargetObject>
                <TargetObject condition="contains">\CurrentVersion\Windows\Load</TargetObject>
                <TargetObject condition="contains">\CurrentVersion\Windows\Run</TargetObject>
                <TargetObject condition="contains">\CurrentVersion\Winlogon\</TargetObject>
                <TargetObject condition="contains">\Policies\Explorer\Run</TargetObject>
                <TargetObject condition="contains">\Group Policy\Scripts</TargetObject>
                <TargetObject condition="contains">\Policies\System\EnableLUA</TargetObject>
                <TargetObject condition="contains">\Windows Defender\</TargetObject>
                <TargetObject condition="contains">\Real-Time Protection</TargetObject>
                <TargetObject condition="contains">\Security\Trusted Documents\</TargetObject>
                <TargetObject condition="contains">\Security\VBAWarnings</TargetObject>
                <TargetObject condition="contains">\Security\ProtectedView\</TargetObject>
                <TargetObject condition="contains">\Security\FileBlock\</TargetObject>
                <TargetObject condition="contains">\PowerShell\1\ShellIds\Microsoft.PowerShell\ExecutionPolicy</TargetObject>
                <TargetObject condition="contains">\Policies\Microsoft\Windows\PowerShell\</TargetObject>
                <TargetObject condition="contains">\Schedule\TaskCache\Tree\</TargetObject>
                <TargetObject condition="contains">\Schedule\TaskCache\Tasks\</TargetObject>
                <TargetObject condition="contains">\Internet Settings\</TargetObject>
                <TargetObject condition="contains">\Connections\DefaultConnectionSettings</TargetObject>
                <TargetObject condition="contains">\ROOT\subscription\</TargetObject>
                <TargetObject condition="contains">\ROOT\default\</TargetObject>
            </RegistryEvent>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 14 : REGISTRY RENAME-->
        <RuleGroup name="" groupRelation="or">
            <RegistryEvent onmatch="include">
                <!-- Monitor renames in persistence locations -->
                <TargetObject condition="contains">CurrentVersion\Run</TargetObject>
                <TargetObject condition="contains">CurrentVersion\RunOnce</TargetObject>
                <TargetObject condition="contains">\Services\</TargetObject>
                <TargetObject condition="contains">\Schedule\TaskCache\Tree\</TargetObject>
            </RegistryEvent>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 15 : FILE CREATE STREAM HASH-->
        <RuleGroup name="" groupRelation="or">
            <FileCreateStreamHash onmatch="include">
                <!-- Monitor alternate data streams -->
                <TargetFilename condition="contains">:</TargetFilename>
            </FileCreateStreamHash>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 17 : PIPE CREATED-->
        <RuleGroup name="" groupRelation="or">
            <PipeEvent onmatch="include">
                <!-- Monitor suspicious named pipes -->
                <PipeName condition="contains">msf</PipeName>
                <PipeName condition="contains">cobalt</PipeName>
                <PipeName condition="contains">beacon</PipeName>
                <PipeName condition="contains">evil</PipeName>
                <PipeName condition="contains">meterpreter</PipeName>
                <PipeName condition="contains">stage</PipeName>
                <PipeName condition="contains">payload</PipeName>
            </PipeEvent>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 18 : PIPE CONNECTED-->
        <RuleGroup name="" groupRelation="or">
            <PipeEvent onmatch="include">
                <!-- Monitor suspicious named pipes -->
                <PipeName condition="contains">msf</PipeName>
                <PipeName condition="contains">cobalt</PipeName>
                <PipeName condition="contains">beacon</PipeName>
                <PipeName condition="contains">evil</PipeName>
                <PipeName condition="contains">meterpreter</PipeName>
                <PipeName condition="contains">stage</PipeName>
                <PipeName condition="contains">payload</PipeName>
            </PipeEvent>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 19 : WMI EVENT FILTER ACTIVITY-->
        <RuleGroup name="" groupRelation="or">
            <WmiEvent onmatch="include">
                <!-- Monitor all WMI persistence attempts -->
                <Operation condition="is">Created</Operation>
                <Operation condition="is">Deleted</Operation>
            </WmiEvent>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 20 : WMI EVENT CONSUMER ACTIVITY-->
        <RuleGroup name="" groupRelation="or">
            <WmiEvent onmatch="include">
                <!-- Monitor all WMI persistence attempts -->
                <Operation condition="is">Created</Operation>
                <Operation condition="is">Deleted</Operation>
            </WmiEvent>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 21 : WMI EVENT CONSUMER TO FILTER ACTIVITY-->
        <RuleGroup name="" groupRelation="or">
            <WmiEvent onmatch="include">
                <!-- Monitor all WMI persistence attempts -->
                <Operation condition="is">Created</Operation>
                <Operation condition="is">Deleted</Operation>
            </WmiEvent>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 22 : DNS QUERY-->
        <RuleGroup name="" groupRelation="or">
            <DnsQuery onmatch="exclude">
                <!-- Exclude common legitimate domains -->
                <QueryName condition="end">microsoft.com</QueryName>
                <QueryName condition="end">windows.com</QueryName>
                <QueryName condition="end">office.com</QueryName>
                <QueryName condition="end">live.com</QueryName>
                <QueryName condition="end">google.com</QueryName>
                <QueryName condition="end">youtube.com</QueryName>
                <QueryName condition="end">googleapis.com</QueryName>
                <QueryName condition="end">gstatic.com</QueryName>
                
                <!-- Exclude local domains -->
                <QueryName condition="end">.local</QueryName>
                <QueryName condition="end">.lan</QueryName>
                
                <!-- Exclude reverse DNS -->
                <QueryName condition="end">.in-addr.arpa</QueryName>
                <QueryName condition="end">.ip6.arpa</QueryName>
                
                <!-- Exclude WPAD -->
                <QueryName condition="is">wpad</QueryName>
                <QueryName condition="begin">wpad.</QueryName>
            </DnsQuery>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 23 : FILE DELETE-->
        <RuleGroup name="" groupRelation="or">
            <FileDelete onmatch="include">
                <!-- Monitor deletion of security tools -->
                <TargetFilename condition="contains">antivirus</TargetFilename>
                <TargetFilename condition="contains">defender</TargetFilename>
                <TargetFilename condition="contains">firewall</TargetFilename>
                <TargetFilename condition="contains">security</TargetFilename>
                
                <!-- Monitor deletion of log files -->
                <TargetFilename condition="end">.evtx</TargetFilename>
                <TargetFilename condition="end">.log</TargetFilename>
                
                <!-- Monitor deletion of executables and scripts -->
                <TargetFilename condition="end">.exe</TargetFilename>
                <TargetFilename condition="end">.dll</TargetFilename>
                <TargetFilename condition="end">.ps1</TargetFilename>
                <TargetFilename condition="end">.bat</TargetFilename>
                <TargetFilename condition="end">.cmd</TargetFilename>
                <TargetFilename condition="end">.vbs</TargetFilename>
            </FileDelete>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 24 : CLIPBOARD CHANGED-->
        <RuleGroup name="" groupRelation="or">
            <ClipboardChange onmatch="include">
                <!-- Monitor clipboard changes that might indicate data theft -->
                <ClientInfo condition="contains">powershell</ClientInfo>
                <ClientInfo condition="contains">cmd</ClientInfo>
                <ClientInfo condition="contains">script</ClientInfo>
            </ClipboardChange>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 25 : PROCESS TAMPERING-->
        <RuleGroup name="" groupRelation="or">
            <ProcessTampering onmatch="include">
                <!-- Monitor all process tampering -->
                <Type condition="is">Image is replaced</Type>
                <Type condition="is">Image is hollowed</Type>
            </ProcessTampering>
        </RuleGroup>
        
        <!--SYSMON EVENT ID 26 : FILE DELETE LOGGED-->
        <RuleGroup name="" groupRelation="or">
            <FileDeleteDetected onmatch="include">
                <!-- Monitor deletion of important files -->
                <TargetFilename condition="end">.evtx</TargetFilename>
                <TargetFilename condition="end">.exe</TargetFilename>
                <TargetFilename condition="end">.dll</TargetFilename>
                <TargetFilename condition="end">.ps1</TargetFilename>
                <TargetFilename condition="end">.bat</TargetFilename>
                <TargetFilename condition="end">.cmd</TargetFilename>
                <TargetFilename condition="end">.vbs</TargetFilename>
                <TargetFilename condition="contains">sysmon</TargetFilename>
            </FileDeleteDetected>
        </RuleGroup>
        
    </EventFiltering>
</Sysmon>
