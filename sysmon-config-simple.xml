<Sysmon schemaversion="4.90">
  <!--
  Sysmon Configuration for MITRE ATT&CK Detection
  Compatible with Sysmon v15.15 - Using only supported conditions
  -->
  <EventFiltering>
    
    <!-- Event ID 1: Process Creation -->
    <ProcessCreate onmatch="exclude">
      <Image condition="is">C:\Windows\System32\conhost.exe</Image>
      <Image condition="is">C:\Windows\System32\wbem\WmiPrvSE.exe</Image>
    </ProcessCreate>

    <!-- Event ID 3: Network Connections -->
    <NetworkConnect onmatch="include">
      <!-- Monitor all network connections (minimal filtering) -->
    </NetworkConnect>

    <!-- Event ID 7: Image/Library Loaded -->
    <ImageLoad onmatch="include">
      <!-- Monitor suspicious locations -->
      <ImageLoaded condition="contains">temp</ImageLoaded>
      <ImageLoaded condition="contains">tmp</ImageLoaded>
      <ImageLoaded condition="contains">appdata</ImageLoaded>
    </ImageLoad>

    <!-- Event ID 8: CreateRemoteThread -->
    <CreateRemoteThread onmatch="include">
      <!-- Monitor all remote thread creation -->
    </CreateRemoteThread>

    <!-- Event ID 10: Process Access -->
    <ProcessAccess onmatch="include">
      <!-- Monitor access to critical processes -->
      <TargetImage condition="contains">lsass.exe</TargetImage>
      <TargetImage condition="contains">winlogon.exe</TargetImage>
      <TargetImage condition="contains">csrss.exe</TargetImage>
    </ProcessAccess>

    <!-- Event ID 11: File Create -->
    <FileCreate onmatch="include">
      <!-- Monitor executable files -->
      <TargetFilename condition="end with">.exe</TargetFilename>
      <TargetFilename condition="end with">.dll</TargetFilename>
      <TargetFilename condition="end with">.ps1</TargetFilename>
      <TargetFilename condition="end with">.bat</TargetFilename>
      <TargetFilename condition="end with">.cmd</TargetFilename>
      <!-- Monitor suspicious paths -->
      <TargetFilename condition="contains">temp</TargetFilename>
      <TargetFilename condition="contains">tmp</TargetFilename>
    </FileCreate>

    <!-- Event ID 12,13,14: Registry Events -->
    <RegistryEvent onmatch="include">
      <!-- Persistence locations -->
      <TargetObject condition="contains">Run</TargetObject>
      <TargetObject condition="contains">RunOnce</TargetObject>
      <TargetObject condition="contains">Services</TargetObject>
      <TargetObject condition="contains">Winlogon</TargetObject>
    </RegistryEvent>

    <!-- Event ID 15: File Stream Created -->
    <FileCreateStreamHash onmatch="include">
      <TargetFilename condition="contains">temp</TargetFilename>
      <TargetFilename condition="contains">tmp</TargetFilename>
    </FileCreateStreamHash>

    <!-- Event ID 22: DNS Queries -->
    <DnsQuery onmatch="exclude">
      <!-- Exclude common legitimate domains -->
      <QueryName condition="end with">.microsoft.com</QueryName>
      <QueryName condition="end with">.windows.com</QueryName>
      <QueryName condition="end with">.google.com</QueryName>
    </DnsQuery>

    <!-- Event ID 23: File Delete -->
    <FileDelete onmatch="include">
      <TargetFilename condition="contains">temp</TargetFilename>
      <TargetFilename condition="contains">tmp</TargetFilename>
      <TargetFilename condition="end with">.log</TargetFilename>
    </FileDelete>

  </EventFiltering>
</Sysmon>
